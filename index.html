<script>
/* Replace the existing script content with this block. It contains:
   - the SYSTEM_PROMPT_THINKING with search instructions
   - detectSearchQuery + createSearchPanel UI
   - sendMessagesToApi() streaming helper that builds the search flow
   - chat submit that uses sendMessagesToApi()
*/

const API_KEY = 'csk-2mv8nxk4tpykc2hmhw4kywtpnp3hmtn5nc4fkn9y5y5jhrmp';
const API_URL = 'https://api.cerebras.ai/v1/chat/completions';

const AVAILABLE_MODELS = [
    { id: 'qwen-3-235b-a22b-instruct-2507', name: 'Qwen 3 235B', description: 'Heavy duty instructions' },
    { id: 'sumo-ai-gen', name: 'SumoAiGenerator', description: 'Image generator' }
];

let currentModelId = AVAILABLE_MODELS[0].id;

const chatContainer = document.getElementById('chat-container');
const messagesList = document.getElementById('messages-list');
const welcomeScreen = document.getElementById('welcome-screen');
const chatForm = document.getElementById('chat-form');
const userInput = document.getElementById('user-input');
const sendBtn = document.getElementById('send-btn');
const modelNameDisplays = document.querySelectorAll('.model-name-display');

marked.setOptions({
    highlight: function(code, lang) {
        const language = hljs.getLanguage(lang) ? lang : 'plaintext';
        return hljs.highlight(code, { language }).value;
    },
    langPrefix: 'hljs language-',
    breaks: true,
    gfm: true
});

const SYSTEM_PROMPT_BASIC = "You are a helpful, expert coding assistant. Answer concisely and accurately.";

const SYSTEM_PROMPT_THINKING = `You are a helpful, expert coding assistant.

CRITICAL INSTRUCTION:
To provide the highest quality answer, you MUST engage in a "Chain of Thought" reasoning process before answering.

If you determine that up-to-date or external information is required to answer the user correctly, inside the <think>...</think> block output exactly one search tag with the query you want performed and nothing else in that tag. Use either of these formats (prefer the first):

<search>your concise search query here</search>

or

[[SEARCH: your concise search query here]]

The front-end will detect this tag, present a small search panel and instructions (open a browser tab for the query and/or paste results). After search results are injected into the conversation, continue the reasoning and deliver the final answer.

FORMATTING RULES:
1. Start Immediately: Begin your response with <think>. No filler text.
2. Thinking Process: Inside <think>...</think>, Analyze, Plan, Critique.
   - If a web search is needed: output <search>query</search> (exactly as above) and stop producing the final answer until search results are provided.
3. Final Output: After closing </think>, provide the polished answer.
4. Keep the final answer concise unless asked for details.
`;

let messages = [];

// Detect search instructions in thinking text
function detectSearchQuery(text) {
    if (!text) return null;
    const m1 = /<search>([\\s\\S]*?)<\\/search>/i.exec(text);
    if (m1) return m1[1].trim();
    const m2 = /\\[\\[SEARCH:\\s*([\\s\\S]*?)\\]\\]/i.exec(text);
    if (m2) return m2[1].trim();
    return null;
}

// UI to show the search action and accept pasted results
function createSearchPanel(container, query, onProvideResults) {
    const existing = container.querySelector('.search-panel');
    if (existing) return existing;

    const panel = document.createElement('div');
    panel.className = 'search-panel';

    panel.innerHTML = `
        <div class="flex items-start justify-between gap-3">
            <div class="text-sm text-gray-300">Assistant requested a web lookup:</div>
            <div class="text-xs text-gray-400">Query: <strong>${DOMPurify.sanitize(query)}</strong></div>
        </div>
        <div class="mt-2 text-sm text-gray-400">Open a search in a new tab (recommended) or paste the search results below and click <em>Provide results to AI</em>.</div>
        <div class="flex gap-2 mt-3">
            <button class="open-search-btn px-3 py-1 rounded-md border border-white/10 text-sm">Open web search</button>
            <button class="fetch-snippet-btn px-3 py-1 rounded-md border border-white/10 text-sm">(Optional) Fetch snippet via GET</button>
        </div>
        <textarea placeholder="Paste top search result or summary here..." class="mt-3"></textarea>
        <div class="flex justify-end mt-2">
            <button class="provide-results px-3 py-1 rounded-md bg-white text-black">Provide results to AI</button>
        </div>
    `;

    panel.querySelector('.open-search-btn').addEventListener('click', (e) => {
        window.open('https://www.google.com/search?q=' + encodeURIComponent(query), '_blank');
    });

    panel.querySelector('.fetch-snippet-btn').addEventListener('click', async (e) => {
        const url = 'https://r.jina.ai/http://www.google.com/search?q=' + encodeURIComponent(query);
        const ta = panel.querySelector('textarea');
        ta.value = 'Attempting to fetch top result text...';
        try {
            const resp = await fetch(url);
            const txt = await resp.text();
            ta.value = txt.slice(0, 4000);
        } catch (err) {
            ta.value = 'Automatic fetch failed (CORS/proxy). Please open the web search and paste results manually.';
        }
    });

    panel.querySelector('.provide-results').addEventListener('click', (e) => {
        const ta = panel.querySelector('textarea');
        const content = ta.value.trim();
        if (!content) {
            alert('Paste search results or summary before providing.');
            return;
        }
        onProvideResults(content);
    });

    container.appendChild(panel);
    return panel;
}

// --- Model UI / selectors (unchanged) ---
function initModelSelectors() {
    const dropdowns = [document.getElementById('mobile-dropdown'), document.getElementById('desktop-dropdown')];
    dropdowns.forEach(dropdown => {
        if (!dropdown) return;
        dropdown.innerHTML = '';
        AVAILABLE_MODELS.forEach(model => {
            const item = document.createElement('button');
            item.className = "w-full text-left px-3 py-2.5 rounded-lg hover:bg-white/5 transition-colors flex items-center justify-between group";
            item.onclick = () => selectModel(model.id);

            const textContainer = document.createElement('div');
            textContainer.className = "flex flex-col";

            const nameSpan = document.createElement('span');
            nameSpan.className = "text-sm font-medium text-gray-200 group-hover:text-white";
            nameSpan.innerText = model.name;

            const descSpan = document.createElement('span');
            descSpan.className = "text-xs text-gray-500 group-hover:text-gray-400";
            descSpan.innerText = model.description;

            textContainer.appendChild(nameSpan);
            textContainer.appendChild(descSpan);
            item.appendChild(textContainer);

            if (model.id === currentModelId) {
                const check = document.createElement('i');
                check.className = "ph ph-check text-white text-lg";
                item.appendChild(check);
            }
            dropdown.appendChild(item);
        });
    });
}

function toggleDropdown(type) {
    const dropdown = document.getElementById(`${type}-dropdown`);
    const allDropdowns = document.querySelectorAll('.dropdown-menu');
    allDropdowns.forEach(d => { if (d !== dropdown) d.classList.remove('active'); });
    dropdown.classList.toggle('active');
}

function resetChat() {
    // Make Qwen use thinking prompt so it can decide to search.
    let initialPrompt = SYSTEM_PROMPT_THINKING;
    if (currentModelId === 'sumo-ai-gen') initialPrompt = SYSTEM_PROMPT_BASIC;

    messages = [{ role: "system", content: initialPrompt }];

    messagesList.innerHTML = '';
    messagesList.classList.add('hidden');
    welcomeScreen.style.display = 'flex';
    welcomeScreen.style.opacity = '1';

    userInput.value = '';
    userInput.style.height = 'auto';
    sendBtn.disabled = true;
    sendBtn.classList.add('bg-transparent', 'text-gray-500');
    sendBtn.classList.remove('bg-white', 'text-black');
}

function selectModel(id) {
    currentModelId = id;
    const modelObj = AVAILABLE_MODELS.find(m => m.id === id);
    modelNameDisplays.forEach(el => el.innerText = modelObj.name);
    userInput.placeholder = `Message ${modelObj.name}`;
    initModelSelectors();
    document.querySelectorAll('.dropdown-menu').forEach(d => d.classList.remove('active'));
    resetChat();
}

document.addEventListener('click', (e) => {
    if (!e.target.closest('.relative')) {
        document.querySelectorAll('.dropdown-menu').forEach(d => d.classList.remove('active'));
        const attachMenu = document.getElementById('attach-menu');
        const attachBtn = document.getElementById('attach-btn-real');
        if (attachMenu && !attachMenu.contains(e.target) && !attachBtn.contains(e.target)) {
            attachMenu.classList.add('hidden');
        }
    }
});

initModelSelectors();
document.querySelectorAll('.model-name-display').forEach(el => el.innerText = AVAILABLE_MODELS[0].name);
resetChat();

// ---------- Chat rendering helpers (unchanged) ----------
function appendMessage(role, content, isLoading = false) {
    if (messagesList.classList.contains('hidden')) {
        messagesList.classList.remove('hidden');
        welcomeScreen.style.display = 'none';
    }

    const messageRow = document.createElement('div');
    messageRow.className = `w-full flex ${role === 'user' ? 'justify-end' : 'justify-start'}`;

    const bubble = document.createElement('div');

    if (role === 'user') {
        bubble.className = "bg-[#2f2f2f] text-white px-5 py-2.5 rounded-3xl max-w-[85%] sm:max-w-[75%] text-base leading-relaxed break-words";
        bubble.innerText = content;
        messageRow.appendChild(bubble);
        messagesList.appendChild(messageRow);
    } else {
        bubble.className = "text-gray-100 max-w-full w-full prose prose-invert prose-p:leading-relaxed prose-pre:p-0";
        const container = document.createElement('div');
        container.className = "flex gap-4 w-full max-w-3xl";
        const icon = document.createElement('div');
        icon.className = "flex-shrink-0 w-8 h-8 rounded-full border border-white/10 flex items-center justify-center mt-1";
        icon.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z" stroke="white" stroke-width="2" stroke-linejoin="round"/></svg>`;
        const textContent = document.createElement('div');
        textContent.className = "flex-1 min-w-0 overflow-hidden";
        const thinkingContainer = document.createElement('div');
        thinkingContainer.className = "thought-wrapper hidden mb-4";
        const answerContainer = document.createElement('div');
        answerContainer.className = "answer-wrapper";
        if (isLoading) {
            answerContainer.innerHTML = `<div class="flex items-center gap-1 h-6"><div class="w-2 h-2 rounded-full typing-dot"></div></div>`;
        } else if (content) {
            answerContainer.innerHTML = DOMPurify.sanitize(marked.parse(content));
        }
        textContent.appendChild(thinkingContainer);
        textContent.appendChild(answerContainer);
        bubble.appendChild(textContent);
        container.appendChild(icon);
        container.appendChild(textContent);
        messageRow.appendChild(container);
        messagesList.appendChild(messageRow);
        return {
            row: messageRow,
            thinkingContainer: thinkingContainer,
            answerContainer: answerContainer,
            loader: answerContainer.firstChild,
            bubble: bubble
        };
    }
    return { row: messageRow };
}

function scrollToBottom() {
    chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
}

// ---------- API streaming / search-aware flow ----------
async function sendMessagesToApi() {
    const aiMsgEls = appendMessage('assistant', '', true);
    scrollToBottom();

    let fullResponse = "";

    try {
        const apiMessages = messages.map(m => ({ ...m }));

        const response = await fetch(API_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${API_KEY}`
            },
            body: JSON.stringify({
                model: currentModelId,
                messages: apiMessages,
                stream: true,
                temperature: 0.7,
                max_tokens: 4000
            })
        });

        if (!response.ok) throw new Error('API Error');

        if (aiMsgEls.answerContainer) aiMsgEls.answerContainer.innerHTML = '';

        const reader = response.body.getReader();
        const decoder = new TextDecoder("utf-8");

        while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            const chunk = decoder.decode(value, { stream: true });
            const lines = chunk.split('\\n');

            for (const line of lines) {
                if (line.startsWith('data: ') && line !== 'data: [DONE]') {
                    try {
                        const json = JSON.parse(line.substring(6));
                        const content = json.choices[0]?.delta?.content || "";
                        fullResponse += content;

                        const thinkStartMatch = /<think>/i.exec(fullResponse);
                        const thinkEndMatch = /<\\/think>/i.exec(fullResponse);
                        const thinkStart = thinkStartMatch ? thinkStartMatch.index : -1;
                        const thinkEnd = thinkEndMatch ? thinkEndMatch.index : -1;

                        let thoughtPart = "";
                        let answerPart = fullResponse;
                        let isThinking = false;

                        if (thinkStart !== -1) {
                            if (thinkEnd !== -1) {
                                thoughtPart = fullResponse.substring(thinkStart + 7, thinkEnd);
                                const postThink = fullResponse.substring(thinkEnd + 8);
                                answerPart = postThink;
                            } else {
                                thoughtPart = fullResponse.substring(thinkStart + 7);
                                answerPart = "";
                                isThinking = true;
                            }
                        }

                        if (thoughtPart) {
                            aiMsgEls.thinkingContainer.classList.remove('hidden');

                            // if thought requests search, create UI for the user to run/ paste results
                            const query = detectSearchQuery(thoughtPart);
                            if (query) {
                                createSearchPanel(aiMsgEls.thinkingContainer, query, (searchResults) => {
                                    // When user provides search results, add them as a user message and continue the flow
                                    messages.push({ role: 'user', content: `SEARCH RESULTS for: "${query}"\n\n${searchResults}` });
                                    // continue conversation (assistant should pick up and produce final answer)
                                    sendMessagesToApi();
                                });
                            }

                            const detailsHTML = `
                                <details class="group" ${isThinking ? 'open' : ''}>
                                    <summary class="list-none flex items-center gap-2 text-gray-400 hover:text-gray-200 cursor-pointer transition-colors text-sm select-none font-medium">
                                        <i class="ph ph-brain text-lg"></i>
                                        <span>${isThinking ? 'Thinking...' : 'Thought Process'}</span>
                                        <i class="ph ph-caret-down group-open:rotate-180 transition-transform ml-auto opacity-50"></i>
                                    </summary>
                                    <div class="mt-2 text-gray-400 text-sm leading-relaxed border-l-2 border-gray-700 pl-3">
                                        ${DOMPurify.sanitize(marked.parse(thoughtPart))}
                                    </div>
                                </details>
                            `;
                            aiMsgEls.thinkingContainer.innerHTML = detailsHTML;
                        }

                        if (answerPart) {
                            aiMsgEls.answerContainer.innerHTML = DOMPurify.sanitize(marked.parse(answerPart));
                            aiMsgEls.answerContainer.querySelectorAll('pre code').forEach((block) => {
                                hljs.highlightElement(block);
                            });
                        } else if (isThinking) {
                            aiMsgEls.answerContainer.innerHTML = '';
                        }

                        scrollToBottom();
                    } catch (e) {
                        // ignore parse errors
                    }
                }
            }
        }

        messages.push({ role: "assistant", content: fullResponse });

    } catch (error) {
        console.error(error);
        if (aiMsgEls.answerContainer) aiMsgEls.answerContainer.innerHTML = `<span class="text-red-400">Error connecting to AI.</span>`;
    }
}

// Form submit
chatForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const text = userInput.value.trim();
    if (!text) return;

    appendMessage('user', text);
    messages.push({ role: "user", content: text });

    userInput.value = '';
    userInput.style.height = 'auto';
    sendBtn.disabled = true;
    sendBtn.classList.add('bg-transparent', 'text-gray-500');
    sendBtn.classList.remove('bg-white', 'text-black');

    scrollToBottom();

    // Image generator flow
    if (currentModelId === 'sumo-ai-gen') {
        const aiMsgEls = appendMessage('assistant', '', true);
        scrollToBottom();
        await new Promise(r => setTimeout(r, 1200));
        const imgUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(text)}?nologo=true`;
        const responseText = `**Generated Image** for: _${text}_\n\n![${text}](${imgUrl})`;
        aiMsgEls.answerContainer.innerHTML = DOMPurify.sanitize(marked.parse(responseText));
        messages.push({ role: "assistant", content: responseText });
        scrollToBottom();
        return;
    }

    // Standard: send and stream
    await sendMessagesToApi();
});

// Attach menu toggling (unchanged)
const attachBtn = document.getElementById('attach-btn-real');
const attachMenu = document.getElementById('attach-menu');

attachBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    attachMenu.classList.toggle('hidden');
});

document.getElementById('attach-btn').style.display = 'none';
attachBtn.classList.remove('hidden');

</script>
